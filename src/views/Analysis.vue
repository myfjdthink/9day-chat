<template>
  <div class="flex-1 p-8 bg-gray-50 dark:bg-gray-900 relative">
    <!-- SEOç»„ä»¶ -->
    <SEO 
      title="ä¸“ä¸šå…«å­—åˆ†ææ’ç›˜ - AIæ™ºèƒ½å‘½ç†è§£è¯» | åŒ—æ–—ä¹å·æ—¥å†"
      description="æä¾›ä¸“ä¸šçš„å…«å­—åˆ†ææ’ç›˜æœåŠ¡ï¼Œæ™ºèƒ½è§£è¯»å‘½ç†æ ¼å±€ã€ç”¨ç¥å–œå¿Œã€åç¥å…³ç³»ã€æµå¹´è¿åŠ¿ç­‰ã€‚åŸºäºä¼ ç»Ÿå››æŸ±å…«å­—ç†è®ºï¼Œç»“åˆAIç®—æ³•ï¼Œä¸ºæ‚¨æä¾›ç²¾å‡†çš„å‘½ç†åˆ†ææŠ¥å‘Šå’Œäººç”ŸæŒ‡å¯¼å»ºè®®ã€‚æ”¯æŒåœ¨çº¿å…«å­—æ’ç›˜ã€å¤§è¿åˆ†æã€æµå¹´é¢„æµ‹ã€‚"
      keywords="å…«å­—åˆ†æ,å…«å­—æ’ç›˜,å‘½ç†åˆ†æ,ç”¨ç¥åˆ†æ,åç¥åˆ†æ,å¤§è¿æµå¹´,å‘½ç†æ ¼å±€,å››æŸ±å…«å­—,åœ¨çº¿æ’ç›˜,AIå‘½ç†è§£è¯»"
    />
    
    <div class="max-w-6xl mx-auto">
      <!-- é¡µé¢ä¸»æ ‡é¢˜ -->
      <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6 text-center">ä¸“ä¸šå…«å­—åˆ†ææ’ç›˜ - AIæ™ºèƒ½å‘½ç†è§£è¯»</h1>
      
      <!-- åŠŸèƒ½ä»‹ç»å¡ç‰‡ -->
      <div v-if="!analysisResult" class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="text-center">
            <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-3">
              <User class="w-6 h-6 text-white" />
            </div>
            <h3 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">å…«å­—æ’ç›˜</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300">ç²¾ç¡®è®¡ç®—æ‚¨çš„å…«å­—å‘½ç›˜ï¼Œåˆ†æäº”è¡Œå±æ€§å’Œæ ¼å±€</p>
          </div>
          <div class="text-center">
            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-3">
              <BarChart3 class="w-6 h-6 text-white" />
            </div>
            <h3 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">å…¨é¢åˆ†æ</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300">æä¾›æ€§æ ¼ã€äº‹ä¸šã€è´¢è¿ã€æ„Ÿæƒ…ç­‰å¤šç»´åº¦æ·±åº¦åˆ†æ</p>
          </div>
          <div class="text-center">
            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-3">
              <Lightbulb class="w-6 h-6 text-white" />
            </div>
            <h3 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">ä¸“ä¸šå»ºè®®</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300">åŸºäºå‘½ç†åˆ†ææä¾›äººç”ŸæŒ‡å¯¼å’Œå‘å±•å»ºè®®</p>
          </div>
        </div>
      </div>

      <!-- è¾“å…¥éƒ¨åˆ† -->
      <div v-if="!analysisResult" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Basic Information -->
        <div class="space-y-6 border border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-800 shadow-sm p-6">
          <div class="flex items-center space-x-2 mb-6">
            <User class="w-5 h-5 text-green-500" />
            <h2 class="text-lg font-medium text-gray-900 dark:text-gray-100">åŸºæœ¬ä¿¡æ¯</h2>
          </div>

          <!-- Gender Selection -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">æ€§åˆ«</label>
            <div class="flex space-x-3">
              <Button
                :variant="gender === 'ç”·' ? 'default' : 'outline'"
                @click="gender = 'ç”·'"
              >
                ç”·
              </Button>
              <Button
                :variant="gender === 'å¥³' ? 'default' : 'outline'"
                @click="gender = 'å¥³'"
              >
                å¥³
              </Button>
            </div>
          </div>

          <!-- Birth Date and Time -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
              å‡ºç”Ÿæ—¥æœŸå’Œæ—¶é—´ <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <Input
                type="datetime-local"
                v-model="birthDateTime"
                class="w-full"
              />
              <CalendarIcon class="absolute right-3 top-3 w-4 h-4 text-gray-400" />
            </div>

            <!-- Confirmation Message -->
            <div class="mt-3 p-3 bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded-md">
              <div class="flex items-center space-x-2">
                <CalendarIcon class="w-4 h-4 text-green-600" />
                <span class="text-sm text-green-800 dark:text-green-200">
                  å·²é€‰æ‹©ï¼š{{ formatDateTime(birthDateTime) }} <span class="text-green-600">(æ–°å†)</span>
                </span>
              </div>
            </div>

            <p class="text-xs text-gray-500 dark:text-gray-300 mt-2">å‡ºç”Ÿæ—¶é—´å·²é€‰æ‹©ï¼Œå¯ç‚¹å‡»è¾“å…¥æ¡†é‡æ–°è°ƒæ•´</p>
          </div>
        </div>

        <!-- Analysis Configuration -->
        <div class="space-y-6 border border-gray-200 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-800 shadow-sm p-6">
          <div class="flex items-center space-x-2 mb-6">
            <Settings class="w-5 h-5 text-green-500" />
            <h2 class="text-lg font-medium text-gray-900 dark:text-gray-100">åˆ†æé…ç½®</h2>
          </div>

          <!-- Analysis Types -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">åˆ†æç±»å‹</label>
            <div class="space-y-3">
              <Card class="border-2 border-blue-200 dark:border-blue-700 dark:bg-gray-800">
                <CardContent class="p-4">
                  <div class="flex items-start space-x-3">
                    <Checkbox
                      :checked="analysisTypes.basic"
                      @update:checked="analysisTypes.basic = $event"
                      class="mt-1"
                    />
                    <div>
                      <h3 class="font-medium text-gray-900 dark:text-gray-100">åŸºç¡€åˆ†æ</h3>
                      <p class="text-sm text-gray-500 dark:text-gray-300">å…«å­—æ’ç›˜ã€äº”è¡Œåˆ†æã€åŸºæœ¬ä¿¡æ¯</p>
                    </div>
                  </div>
                </CardContent>
              </Card>

              <Card class="border-2 border-blue-200 dark:border-blue-700 dark:bg-gray-800">
                <CardContent class="p-4">
                  <div class="flex items-start space-x-3">
                    <Checkbox
                      :checked="analysisTypes.deity"
                      @update:checked="analysisTypes.deity = $event"
                      class="mt-1"
                    />
                    <div>
                      <h3 class="font-medium text-gray-900 dark:text-gray-100">ç”¨ç¥åˆ†æ</h3>
                      <p class="text-sm text-gray-500 dark:text-gray-300">ç”¨ç¥å–œå¿Œã€é¿ç¥åˆ†æã€æ ¼å±€åˆ¤æ–­</p>
                    </div>
                  </div>
                </CardContent>
              </Card>

              <Card class="border-2 border-blue-200 dark:border-blue-700 dark:bg-gray-800">
                <CardContent class="p-4">
                  <div class="flex items-start space-x-3">
                    <Checkbox
                      :checked="analysisTypes.ai"
                      @update:checked="analysisTypes.ai = $event"
                      class="mt-1"
                    />
                    <div>
                      <h3 class="font-medium text-gray-900 dark:text-gray-100">è¿åŠ¿é¢„æµ‹</h3>
                      <p class="text-sm text-gray-500 dark:text-gray-300">è¿åŠ¿åˆ†æã€æ€§æ ¼åˆ†æã€äººç”Ÿå»ºè®®</p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>
          </div>

          <!-- AI Analysis Scope -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">é€‰æ‹©åˆ†æèŒƒå›´</label>
            <div class="flex space-x-3">
              <Button
                :variant="analysisScope.year ? 'default' : 'outline'"
                @click="analysisScope.year = !analysisScope.year"
              >
                æµå¹´
              </Button>
              <Button
                :variant="analysisScope.month ? 'default' : 'outline'"
                @click="analysisScope.month = !analysisScope.month"
              >
                æµæœˆ
              </Button>
              <Button
                :variant="analysisScope.day ? 'default' : 'outline'"
                @click="analysisScope.day = !analysisScope.day"
              >
                æµæ—¥
              </Button>
            </div>
          </div>
        </div>
      </div>

      <!-- Start Analysis Button -->
      <div v-if="!analysisResult" class="mt-8 flex justify-center">
        <Button
          size="lg"
          variant="default"
          :disabled="isAnalyzing"
          @click="handleStartAnalysis"
        >
          <Star class="w-5 h-5 mr-2" />
          {{ isAnalyzing ? 'åˆ†æä¸­...' : 'å¼€å§‹åˆ†æ' }}
        </Button>
      </div>

      <!-- Analysis Results -->
      <div v-if="analysisResult" class="mt-12 space-y-8">
        <!-- æŠ¥å‘Šå†…å®¹åŒºåŸŸï¼Œæ”¯æŒæ»šåŠ¨ -->
        <div ref="reportRef" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 max-h-[90vh] overflow-y-auto">
          <div class="mb-6">
            <h2 class="text-2xl font-bold mb-2 dark:text-gray-100">å…«å­—åˆ†ææŠ¥å‘Š</h2>
            <!-- åˆ†ææ—¶é—´å’Œç±»å‹ -->
            <div class="flex items-center space-x-4 text-sm text-gray-600 dark:text-gray-300">
              <div class="flex items-center space-x-1">
                <CalendarIcon class="w-4 h-4" />
                <span>åˆ†ææ—¶é—´ï¼š{{ formatDateTime(analysisResult.åˆ†ææ—¶é—´) }}</span>
              </div>
              <div class="flex items-center space-x-1">
                <Settings class="w-4 h-4" />
                <span>åˆ†æç±»å‹ï¼š{{ analysisResult.åˆ†æç±»å‹ }}</span>
              </div>
            </div>
          </div>
          
          <!-- åˆ†æå†…å®¹ - ä½¿ç”¨è™šæ‹Ÿåˆ—è¡¨ä¼˜åŒ–é•¿åˆ—è¡¨æ¸²æŸ“ -->
          <div class="space-y-8">
            <template v-for="[type, content] in getSortedAnalysisResults().filter(([type]) => type !== 'ç”¨ç¥åˆ†æ').slice(0, visibleItems)" :key="type">
              <div 
                class="border border-gray-200 dark:border-gray-700 rounded-lg p-6 bg-gray-50 dark:bg-gray-700"
                v-observe-visibility="(isVisible: boolean) => handleVisibilityChange(type, isVisible)"
                :data-type="type"
              >
                <!-- æ ‡é¢˜åŒºåŸŸ -->
                <div class="flex items-center space-x-3 mb-4">
                  <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                    <span class="text-white font-bold text-sm">{{ getAnalysisTypeIcon(type) }}</span>
                  </div>
                  <h3 class="text-xl font-semibold dark:text-gray-100">{{ type === 'åŸºç¡€åˆ†æ' ? 'åŸºç¡€åˆ†æåŠç”¨ç¥åˆ†æ' : type + 'åˆ†æ' }}</h3>
                  <div class="flex-1"></div>
                  <div class="text-xs text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-600 px-2 py-1 rounded">
                    {{ getAnalysisTypeDescription(type) }}
                  </div>
                </div>
                
                <!-- åˆ†æå†…å®¹ - ç»“æ„åŒ–å±•ç¤º -->
                <div v-if="visibleSections[type]">
                  <!-- åŸºç¡€åˆ†æå’Œç”¨ç¥åˆ†æ - å·¦å³å¹¶æ’å¸ƒå±€ï¼ˆä»…åœ¨ç»„åˆæ˜¾ç¤ºæ—¶æ˜¾ç¤ºï¼‰ -->
                  <div v-if="type === 'åŸºç¡€åˆ†æ' && hasBaseAndYongshenData()" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- å·¦ä¾§ï¼šåŸºç¡€åˆ†æ -->
                    <div v-if="getStructuredBaseData(getSortedAnalysisResults().find(([t]) => t === 'åŸºç¡€åˆ†æ')?.[1] || '')" class="space-y-4">
                      <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600 pb-2">åŸºç¡€ä¿¡æ¯</h4>
                      <BaziDisplay 
                        :baziData="getStructuredBaseData(getSortedAnalysisResults().find(([t]) => t === 'åŸºç¡€åˆ†æ')?.[1] || '')!"
                      />
                    </div>
                    
                    <!-- å³ä¾§ï¼šç”¨ç¥åˆ†æ -->
                    <div v-if="getStructuredYongshenData(getSortedAnalysisResults().find(([t]) => t === 'ç”¨ç¥åˆ†æ')?.[1] || '')" class="space-y-4">
                      <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100 border-b border-gray-200 dark:border-gray-600 pb-2">ç”¨ç¥ä¿¡æ¯</h4>
                      <YongshenDisplay 
                        :yongshenData="getStructuredYongshenData(getSortedAnalysisResults().find(([t]) => t === 'ç”¨ç¥åˆ†æ')?.[1] || '')!"
                      />
                    </div>
                  </div>
                  
                  <!-- å•ç‹¬çš„åŸºç¡€åˆ†æï¼ˆä»…åœ¨æ²¡æœ‰ç”¨ç¥åˆ†ææ—¶æ˜¾ç¤ºï¼‰ -->
                  <BaziDisplay 
                    v-else-if="type === 'åŸºç¡€åˆ†æ' && !hasBaseAndYongshenData() && getStructuredBaseData(content)"
                    :baziData="getStructuredBaseData(content)"
                  />
                  
                  <!-- ç”¨ç¥åˆ†æä¸å•ç‹¬æ˜¾ç¤ºï¼Œåªåœ¨åŸºç¡€åˆ†æä¸­ç»„åˆæ˜¾ç¤º -->
                  
                  <!-- å…¶ä»–åˆ†æç±»å‹ - ä¿æŒåŸæœ‰markdownæ ¼å¼ -->
                  <div v-else-if="type !== 'ç”¨ç¥åˆ†æ'" class="prose max-w-none dark:prose-invert prose-sm">
                    <div v-html="formatMarkdown(content)" class="leading-relaxed"></div>
                  </div>
                </div>
                <div v-else class="h-32 flex items-center justify-center">
                  <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 dark:bg-gray-600 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-gray-200 dark:bg-gray-600 rounded w-2/3"></div>
                  </div>
                </div>
              </div>
            </template>
          </div>
          
          <!-- åˆ†ææ€»ç»“ -->
          <div class="mt-8 p-4 bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg">
            <div class="flex items-center space-x-2 mb-2">
              <Star class="w-5 h-5 text-blue-600" />
              <h4 class="font-medium text-blue-800 dark:text-blue-200">åˆ†ææ€»ç»“</h4>
            </div>
            <p class="text-sm text-blue-700 dark:text-blue-300">
              æœ¬æ¬¡åˆ†ææ¶µç›–äº† {{ Object.keys(analysisResult.åˆ†æç»“æœ).length }} ä¸ªç»´åº¦ï¼Œ
              ä¸ºæ‚¨æä¾›äº†å…¨é¢çš„å…«å­—åˆ†ææŠ¥å‘Šã€‚å»ºè®®æ‚¨æ ¹æ®åˆ†æç»“æœï¼Œç»“åˆå®é™…æƒ…å†µåšå‡ºç›¸åº”çš„è°ƒæ•´å’Œè§„åˆ’ã€‚
            </p>
          </div>
        </div>
        
        <!-- åº•éƒ¨æ“ä½œæ ï¼šsticky å®šä½åœ¨ä¸»å†…å®¹åŒºåº•éƒ¨ï¼Œä¸é®æŒ¡ä¾§è¾¹æ  -->
        <div class="sticky bottom-0 z-50 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 py-4 shadow-lg">
          <div class="w-full max-w-4xl mx-auto flex justify-center gap-6 px-2">
            <Button
              size="lg"
              variant="secondary"
              @click="handleSaveReport"
            >
              <Download class="w-4 h-4 mr-2" />
              ä¿å­˜æŠ¥å‘Š
            </Button>
            <Button
              size="lg"
              variant="outline"
              @click="handleResetAnalysis"
            >
              <RefreshCw class="w-4 h-4 mr-2" />
              é‡æ–°åˆ†æ
            </Button>
            <Button
              size="lg"
              variant="default"
              @click="handleChatWithReport"
            >
              <MessageSquare class="w-4 h-4 mr-2" />
              å¯¹è¯æŠ¥å‘Š
            </Button>
          </div>
        </div>
      </div>
    </div>
    <!-- å…¨å±€åˆ†æä¸­é®ç½© -->
    <div v-if="isAnalyzing" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-30">
      <div class="flex flex-col items-center">
        <svg class="animate-spin h-10 w-10 text-green-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        <div class="flex flex-col items-center">
          <div class="text-lg text-white font-semibold mb-2">æ­£åœ¨ä¸ºæ‚¨åˆ†æï¼Œè¯·ç¨å€™...</div>
          <div class="text-sm text-gray-200">
            é¦–æ¬¡åˆ†æå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…
          </div>
          <div class="text-xs text-gray-300 mt-1">
            å¦‚æœé•¿æ—¶é—´æ— å“åº”ï¼Œè¯·ç‚¹å‡»é‡è¯•
          </div>
        </div>
      </div>
    </div>
    <!-- ä½¿ç”¨è¯´æ˜å’ŒFAQéƒ¨åˆ† -->
    <div v-if="!analysisResult" class="mt-12 space-y-8">
      <!-- ä½¿ç”¨è¯´æ˜ -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6 flex items-center">
          <Settings class="w-6 h-6 mr-2 text-blue-500" />
          ä½¿ç”¨è¯´æ˜
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div class="flex items-start space-x-3">
              <div class="w-6 h-6 bg-purple-500 text-white rounded-full flex items-center justify-center text-sm font-bold mt-1">1</div>
              <div>
                <h4 class="font-semibold text-gray-900 dark:text-gray-100">å¡«å†™åŸºæœ¬ä¿¡æ¯</h4>
                <p class="text-sm text-gray-600 dark:text-gray-300">å‡†ç¡®å¡«å†™æ€§åˆ«ã€å‡ºç”Ÿæ—¥æœŸå’Œæ—¶é—´ï¼Œç¡®ä¿åˆ†æç»“æœçš„å‡†ç¡®æ€§</p>
              </div>
            </div>
            <div class="flex items-start space-x-3">
              <div class="w-6 h-6 bg-purple-500 text-white rounded-full flex items-center justify-center text-sm font-bold mt-1">2</div>
              <div>
                <h4 class="font-semibold text-gray-900 dark:text-gray-100">é€‰æ‹©åˆ†æç±»å‹</h4>
                <p class="text-sm text-gray-600 dark:text-gray-300">æ ¹æ®éœ€è¦é€‰æ‹©åŸºç¡€åˆ†æã€ç”¨ç¥åˆ†ææˆ–è¿åŠ¿é¢„æµ‹</p>
              </div>
            </div>
          </div>
          <div class="space-y-4">
            <div class="flex items-start space-x-3">
              <div class="w-6 h-6 bg-purple-500 text-white rounded-full flex items-center justify-center text-sm font-bold mt-1">3</div>
              <div>
                <h4 class="font-semibold text-gray-900 dark:text-gray-100">è®¾ç½®åˆ†æèŒƒå›´</h4>
                <p class="text-sm text-gray-600 dark:text-gray-300">é€‰æ‹©è¿åŠ¿é¢„æµ‹æ—¶ï¼Œå¯é€‰æ‹©æµå¹´ã€æµæœˆã€æµæ—¥åˆ†æ</p>
              </div>
            </div>
            <div class="flex items-start space-x-3">
              <div class="w-6 h-6 bg-purple-500 text-white rounded-full flex items-center justify-center text-sm font-bold mt-1">4</div>
              <div>
                <h4 class="font-semibold text-gray-900 dark:text-gray-100">å¼€å§‹åˆ†æ</h4>
                <p class="text-sm text-gray-600 dark:text-gray-300">ç‚¹å‡»å¼€å§‹åˆ†æï¼Œè·å¾—è¯¦ç»†çš„å…«å­—å‘½ç†åˆ†ææŠ¥å‘Š</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- FAQéƒ¨åˆ† -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6 flex items-center">
          <Star class="w-6 h-6 mr-2 text-orange-500" />
          å¸¸è§é—®é¢˜
        </h2>
        <div class="space-y-6">
          <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
            <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Q: å…«å­—åˆ†æçš„å‡†ç¡®æ€§å¦‚ä½•ï¼Ÿ</h4>
            <p class="text-sm text-gray-600 dark:text-gray-300">A: åŸºäºä¼ ç»Ÿå…«å­—å‘½ç†å­¦ç†è®ºï¼Œç»“åˆç°ä»£ç®—æ³•åˆ†æã€‚åˆ†æç»“æœä»…ä¾›å‚è€ƒï¼Œä¸èƒ½å®Œå…¨å†³å®šäººç”Ÿå‘½è¿ï¼Œéœ€è¦ç»“åˆä¸ªäººåŠªåŠ›å’Œå®é™…æƒ…å†µã€‚</p>
          </div>
          <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
            <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Q: å‡ºç”Ÿæ—¶é—´ä¸å‡†ç¡®ä¼šå½±å“ç»“æœå—ï¼Ÿ</h4>
            <p class="text-sm text-gray-600 dark:text-gray-300">A: æ˜¯çš„ï¼Œå‡ºç”Ÿæ—¶é—´çš„å‡†ç¡®æ€§ç›´æ¥å½±å“å…«å­—æ’ç›˜å’Œåˆ†æç»“æœã€‚å»ºè®®æä¾›å°½å¯èƒ½å‡†ç¡®çš„å‡ºç”Ÿæ—¶é—´ï¼Œè¯¯å·®æœ€å¥½æ§åˆ¶åœ¨1å°æ—¶å†…ã€‚</p>
          </div>
          <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
            <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Q: åŸºç¡€åˆ†æå’Œç”¨ç¥åˆ†ææœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h4>
            <p class="text-sm text-gray-600 dark:text-gray-300">A: åŸºç¡€åˆ†ææä¾›å…«å­—åŸºæœ¬ä¿¡æ¯å’Œäº”è¡Œåˆ†å¸ƒï¼›ç”¨ç¥åˆ†ææ·±å…¥åˆ†æå‘½å±€æ ¼å±€ï¼Œæ‰¾å‡ºç”¨ç¥å¿Œç¥ï¼›è¿åŠ¿é¢„æµ‹åˆ™åˆ†æç‰¹å®šæ—¶æœŸçš„è¿åŠ¿å˜åŒ–ã€‚</p>
          </div>
          <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
            <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Q: å¦‚ä½•ç†è§£åˆ†æç»“æœä¸­çš„ä¸“ä¸šæœ¯è¯­ï¼Ÿ</h4>
            <p class="text-sm text-gray-600 dark:text-gray-300">A: åˆ†æç»“æœä¼šç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è§£é‡Šä¸“ä¸šæœ¯è¯­ã€‚å¦‚æœ‰ç–‘é—®ï¼Œå¯ä»¥ä½¿ç”¨"å¯¹è¯æŠ¥å‘Š"åŠŸèƒ½è¿›è¡Œè¯¦ç»†å’¨è¯¢ã€‚</p>
          </div>
          <div>
            <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Q: å¯ä»¥ä¿å­˜åˆ†ææŠ¥å‘Šå—ï¼Ÿ</h4>
            <p class="text-sm text-gray-600 dark:text-gray-300">A: å¯ä»¥ï¼Œåˆ†æå®Œæˆåå¯ä»¥ç‚¹å‡»"ä¿å­˜æŠ¥å‘Š"æŒ‰é’®ï¼Œå°†æŠ¥å‘Šä¿å­˜ä¸ºå›¾ç‰‡æ ¼å¼ï¼Œæ–¹ä¾¿æ”¶è—å’Œåˆ†äº«ã€‚</p>
          </div>
        </div>
      </div>
    </div>

    <Modal
      :show="showLoginModal"
      title="ç™»å½•æç¤º"
      message="è¯·å…ˆç™»å½•åå†ä½¿ç”¨æ­¤åŠŸèƒ½"
      confirmText="å»ç™»å½•"
      cancelText="å–æ¶ˆ"
      :onConfirm="handleLoginConfirm"
      :onCancel="handleLoginCancel"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, computed, onMounted, watch, defineAsyncComponent, onUnmounted, nextTick } from 'vue'
import { useIntersectionObserver } from '@vueuse/core'
import type { ObjectDirective, DirectiveBinding } from 'vue'

interface ExtendedHTMLElement extends HTMLElement {
  _observe_visibility_observer?: ReturnType<typeof useIntersectionObserver>
}

// æ³¨å†Œobserve-visibilityæŒ‡ä»¤
const vObserveVisibility: ObjectDirective<ExtendedHTMLElement> = {
  mounted: (el: ExtendedHTMLElement, binding: DirectiveBinding<(isVisible: boolean) => void>) => {
    const observer = useIntersectionObserver(el, ([{ isIntersecting }]) => {
      binding.value(isIntersecting)
    })
    el._observe_visibility_observer = observer
  },
  unmounted: (el: ExtendedHTMLElement) => {
    if (el._observe_visibility_observer) {
      el._observe_visibility_observer.stop()
    }
  }
}
import type { Ref } from 'vue'
import type { BaziAnalysis } from '@/api/bazi'

// UI Components - å¼‚æ­¥åŠ è½½éå…³é”®ç»„ä»¶
const Button = defineAsyncComponent(() => import('@/components/ui/Button.vue'))
const Input = defineAsyncComponent(() => import('@/components/ui/Input.vue'))
const Card = defineAsyncComponent(() => import('@/components/ui/Card.vue'))
const CardContent = defineAsyncComponent(() => import('@/components/ui/CardContent.vue'))
const Checkbox = defineAsyncComponent(() => import('@/components/ui/Checkbox.vue'))
const Modal = defineAsyncComponent(() => import('@/components/ui/Modal.vue'))
const SEO = defineAsyncComponent(() => import('@/components/SEO.vue'))

// åˆ†æç»“æœå±•ç¤ºç»„ä»¶ - æ”¹ä¸ºåŒæ­¥å¯¼å…¥ä»¥é¿å…æ¸²æŸ“å»¶è¿Ÿ
import BaziDisplay from '@/components/BaziDisplay.vue'
import YongshenDisplay from '@/components/YongshenDisplay.vue'
import DayunDisplay from '@/components/DayunDisplay.vue'

// æŒ‰éœ€å¯¼å…¥å›¾æ ‡
import { User, Settings, Calendar as CalendarIcon, Star, Download, RefreshCw, MessageSquare, BarChart3, Lightbulb } from 'lucide-vue-next'

// Third-party libraries
import dayjs from 'dayjs'
import utc from 'dayjs/plugin/utc'
import timezone from 'dayjs/plugin/timezone'
import { marked } from 'marked'
// å¼•å…¥html2canvasç”¨äºæˆªå›¾
import html2canvas from 'html2canvas'

// API
import { analyzeBazi, analyzeBase, analyzeYongshen, ANALYSIS_PARTS } from '@/api/bazi'
import { PROVIDERS, MODELS } from '@/api/config'
// å¼•å…¥ Pinia store
import { useChatStore } from '@/stores/chat'
import { useUserStore } from '@/stores/user'
import { useBaziStore } from '@/stores/bazi'
import { updateUserInfo } from '@/api/user' // æ–°å¢å¯¼å…¥
import { useRoute, useRouter } from 'vue-router' // ä¿è¯è·¯ç”±ç›¸å…³å¯¼å…¥

// é…ç½® dayjs
dayjs.extend(utc)
dayjs.extend(timezone)
dayjs.tz.setDefault('Asia/Shanghai')

interface AnalysisTypes {
  basic: boolean
  deity: boolean
  ai: boolean
}

interface AnalysisScope {
  year: boolean
  month: boolean
  day: boolean
}

const gender = ref<'ç”·' | 'å¥³'>('ç”·')
const birthDateTime = ref<string>('1983-12-11T08:00')
const isAnalyzing = ref<boolean>(false)
const analysisResult = ref<{ åˆ†æç±»å‹: string; åˆ†ææ—¶é—´: string; åˆ†æç»“æœ: Record<string, string> } | null>(null)

// è™šæ‹Ÿåˆ—è¡¨ç›¸å…³çŠ¶æ€
const visibleItems = ref(3) // åˆå§‹æ˜¾ç¤º3ä¸ªé¡¹ç›®
const visibleSections = reactive<Record<string, boolean>>({})
const intersectionObserver = ref<IntersectionObserver | null>(null)

// å¤„ç†å…ƒç´ å¯è§æ€§å˜åŒ–
const handleVisibilityChange = (type: string, isVisible: boolean): void => {
  if (isVisible && !visibleSections[type]) {
    visibleSections[type] = true
    // å¦‚æœå½“å‰å¯è§çš„æ˜¯æœ€åä¸€ä¸ªé¡¹ç›®ï¼Œå¢åŠ å¯è§é¡¹ç›®æ•°é‡
    const currentItems = Object.keys(analysisResult.value?.åˆ†æç»“æœ || {}).slice(0, visibleItems.value)
    if (currentItems[currentItems.length - 1] === type) {
      visibleItems.value += 2
    }
  }
}

// æ¸…ç†è§‚å¯Ÿå™¨
onUnmounted(() => {
  if (intersectionObserver.value) {
    intersectionObserver.value.disconnect()
  }
})

const analysisTypes = reactive<AnalysisTypes>({
  basic: true,
  deity: true,
  ai: true
})

// åˆ†æèŒƒå›´åˆå§‹å€¼å…¨éƒ¨ä¸ºfalseï¼Œéœ€ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©
const analysisScope = reactive<AnalysisScope>({
  year: true,
  month: false,
  day: false
})

// ç”¨äºè·å–åˆ†ææŠ¥å‘ŠåŒºåŸŸçš„DOMå¼•ç”¨
const reportRef = ref<HTMLElement | null>(null)

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ä¸ºåŒ—äº¬æ—¶é—´
const formatDateTime = (dateTime: string): string => {
  return dayjs(dateTime).tz('Asia/Shanghai').format('YYYY-MM-DD HH:mm:ss')
}

// æ ¼å¼åŒ–Markdownå†…å®¹ - ä½¿ç”¨ç¼“å­˜ä¼˜åŒ–æ€§èƒ½
const markdownCache = new Map<string, string>()
const formatMarkdown = (content: string): string => {
  if (markdownCache.has(content)) {
    return markdownCache.get(content)!
  }

  // ç§»é™¤ "æµå¹´/æµæœˆ/æµæ—¥ä¿¡æ¯ï¼š" è¿™æ ·çš„æ ‡é¢˜
  let processedContent = content.replace(/^#\s*æµå¹´\/æµæœˆ\/æµæ—¥ä¿¡æ¯ï¼š?\s*\n*/g, '')
  
  // å¦‚æœå†…å®¹ä»¥ # å¼€å¤´ï¼Œç§»é™¤ç¬¬ä¸€ä¸ªæ ‡é¢˜
  processedContent = processedContent.replace(/^#\s*[^#\n]*\n*/g, '')
  
  let result = marked(processedContent)
  
  // ä¸ºæµå¹´æµæœˆæµæ—¥ä¿¡æ¯æ·»åŠ ç‰¹å®šçš„CSSç±»
  result = result.replace(
    /\*\*([æµå¹´æµæœˆæµæ—¥])ï¼š\*\*/g,
    '<strong class="time-info-label">$1ï¼š</strong>'
  )
  
  // ä¸ºæµå¹´æµæœˆæµæ—¥çš„å†…å®¹æ·»åŠ CSSç±»
  result = result.replace(
    /<strong class="time-info-label">([æµå¹´æµæœˆæµæ—¥])ï¼š<\/strong>\s*([^<\n]+)/g,
    '<strong class="time-info-label">$1ï¼š</strong><span class="time-info-content">$2</span>'
  )
  
  markdownCache.set(content, result)
  return result
}

// è·å–åˆ†æèŒƒå›´æ•°ç»„ï¼Œä¸¥æ ¼æŒ‰é€‰é¡¹è¿”å›
const getAnalysisParts = (): string[] => {
  const parts: string[] = []
  if (analysisScope.year) parts.push(ANALYSIS_PARTS.FLOW_YEAR)
  if (analysisScope.month) parts.push(ANALYSIS_PARTS.FLOW_MONTH)
  if (analysisScope.day) parts.push(ANALYSIS_PARTS.FLOW_DAY)
  return parts
}

// æ–°å¢åˆ†ææˆåŠŸåï¼Œè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°+äº‘ç«¯
const handleStartAnalysis = async (): Promise<void> => {
  if (!birthDateTime.value) {
    alert('è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸæ—¶é—´')
    return
  }

  // æ£€æŸ¥æ˜¯å¦è‡³å°‘é€‰æ‹©äº†ä¸€ç§åˆ†æç±»å‹
  if (!analysisTypes.basic && !analysisTypes.deity && !analysisTypes.ai) {
    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§åˆ†æç±»å‹')
    return
  }

  // å¦‚æœé€‰æ‹©äº†è¿åŠ¿é¢„æµ‹ï¼Œéœ€è¦æ£€æŸ¥åˆ†æèŒƒå›´
  if (analysisTypes.ai) {
    const analysisParts = getAnalysisParts()
    if (analysisParts.length === 0) {
      alert('é€‰æ‹©è¿åŠ¿é¢„æµ‹æ—¶ï¼Œè¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåˆ†æèŒƒå›´')
      return
    }
  }

  try {
    isAnalyzing.value = true
    const birthDateTimeBeijing = dayjs(birthDateTime.value).tz('Asia/Shanghai').format()
    const currentDateTimeBeijing = dayjs().tz('Asia/Shanghai').format()
    
    // åˆå¹¶æ‰€æœ‰åˆ†æç»“æœ
    const allResults: Record<string, string> = {}
    const selectedTypes: string[] = []
    
    // åŸºç¡€åˆ†æ
    if (analysisTypes.basic) {
      const baseResponse = await analyzeBase({
        birth_datetime: birthDateTimeBeijing,
        current_datetime: currentDateTimeBeijing,
        gender: gender.value
      })
      if (baseResponse.success && baseResponse.data) {
        const baseData = baseResponse.data.åŸºç¡€åˆ†æ
        
        // ä¿å­˜åŸå§‹APIæ•°æ®
        rawBaseData.value = baseData
        
        // æ ¼å¼åŒ–åŸºç¡€åˆ†æç»“æœä¸º markdown
        let baseMarkdown = `## åŸºç¡€ä¿¡æ¯\n\n`
        baseMarkdown += `**æ€§åˆ«ï¼š** ${baseData.æ€§åˆ«}\n\n`
        
        baseMarkdown += `### å…«å­—ä¿¡æ¯\n\n`
        Object.entries(baseData.å…«å­—ä¿¡æ¯).forEach(([pillar, info]: [string, any]) => {
          baseMarkdown += `**${pillar}ï¼š** ${info.å¹²æ”¯ç»„åˆ.å¤©å¹²}${info.å¹²æ”¯ç»„åˆ.åœ°æ”¯} (${info.äº”è¡Œå±æ€§.å¤©å¹²äº”è¡Œ}${info.äº”è¡Œå±æ€§.åœ°æ”¯äº”è¡Œ})\n\n`
        })
        
        baseMarkdown += `### äº”è¡Œç»Ÿè®¡\n\n`
        baseMarkdown += `**äº”è¡Œåˆ†å¸ƒï¼š**\n`
        Object.entries(baseData.äº”è¡Œç»Ÿè®¡.äº”è¡Œåˆ†å¸ƒ).forEach(([element, count]) => {
          baseMarkdown += `- ${element}ï¼š${count}\n`
        })
        baseMarkdown += `\n**æœ€å¼ºäº”è¡Œï¼š** ${baseData.äº”è¡Œç»Ÿè®¡.æœ€å¼ºäº”è¡Œ}\n\n`
        baseMarkdown += `**æœ€å¼±äº”è¡Œï¼š** ${baseData.äº”è¡Œç»Ÿè®¡.æœ€å¼±äº”è¡Œ}\n\n`
        
        baseMarkdown += `### å½“å‰å¤§è¿ä¿¡æ¯\n\n`
        const dayun = baseData.å½“å‰å¤§è¿ä¿¡æ¯
        baseMarkdown += `**å¤§è¿ï¼š** ${dayun.å¤©å¹²}${dayun.åœ°æ”¯} (${dayun.äº”è¡Œ.å¤©å¹²äº”è¡Œ}${dayun.äº”è¡Œ.åœ°æ”¯äº”è¡Œ})\n\n`
        
        baseMarkdown += `### æµå¹´æµæœˆæµæ—¥ä¿¡æ¯\n\n`
        const timeInfo = baseData.æµå¹´æµæœˆæµæ—¥ä¿¡æ¯
        baseMarkdown += `**æµå¹´ï¼š** ${timeInfo.æµå¹´.å¤©å¹²}${timeInfo.æµå¹´.åœ°æ”¯} (${timeInfo.æµå¹´.äº”è¡Œ.å¤©å¹²äº”è¡Œ}${timeInfo.æµå¹´.äº”è¡Œ.åœ°æ”¯äº”è¡Œ})\n\n`
        baseMarkdown += `**æµæœˆï¼š** ${timeInfo.æµæœˆ.å¤©å¹²}${timeInfo.æµæœˆ.åœ°æ”¯} (${timeInfo.æµæœˆ.äº”è¡Œ.å¤©å¹²äº”è¡Œ}${timeInfo.æµæœˆ.äº”è¡Œ.åœ°æ”¯äº”è¡Œ})\n\n`
        baseMarkdown += `**æµæ—¥ï¼š** ${timeInfo.æµæ—¥.å¤©å¹²}${timeInfo.æµæ—¥.åœ°æ”¯} (${timeInfo.æµæ—¥.äº”è¡Œ.å¤©å¹²äº”è¡Œ}${timeInfo.æµæ—¥.äº”è¡Œ.åœ°æ”¯äº”è¡Œ})\n\n`
        
        allResults['åŸºç¡€åˆ†æ'] = baseMarkdown
        selectedTypes.push('åŸºç¡€åˆ†æ')
      }
    }
    
    // ç”¨ç¥åˆ†æ
    if (analysisTypes.deity) {
      const deityResponse = await analyzeYongshen({
        birth_datetime: birthDateTimeBeijing,
        current_datetime: currentDateTimeBeijing,
        gender: gender.value
      })
      if (deityResponse.success && deityResponse.data) {
        const deityData = deityResponse.data
        
        // ä¿å­˜åŸå§‹APIæ•°æ®
        rawYongshenData.value = deityData
        
        // æ ¼å¼åŒ–ç”¨ç¥åˆ†æç»“æœä¸º markdown
        let deityMarkdown = `## ç”¨ç¥åˆ†æ\n\n`
        deityMarkdown += `**æ ¼å±€ï¼š** ${deityData.æ ¼å±€}\n\n`
        
        deityMarkdown += `### ç”¨ç¥\n\n`
        deityData.ç”¨ç¥.forEach((god: string) => {
          deityMarkdown += `- ${god}\n`
        })
        
        deityMarkdown += `\n### å¿Œç¥\n\n`
        deityData.å¿Œç¥.forEach((god: string) => {
          deityMarkdown += `- ${god}\n`
        })
        
        deityMarkdown += `\n**å–ç”¨åŸåˆ™ï¼š** ${deityData.å–ç”¨}\n\n`
        deityMarkdown += `### åˆ†æç»“è®º\n\n${deityData.åˆ†æ}\n\n`
        
        allResults['ç”¨ç¥åˆ†æ'] = deityMarkdown
        selectedTypes.push('ç”¨ç¥åˆ†æ')
      }
    }
    
    // è¿åŠ¿é¢„æµ‹ï¼ˆåŸæœ‰çš„AIåˆ†æï¼‰
    if (analysisTypes.ai) {
      const analysisParts = getAnalysisParts()
      const aiResponse = await analyzeBazi({
        birth_datetime: birthDateTimeBeijing,
        current_datetime: currentDateTimeBeijing,
        gender: gender.value,
        analysis_parts: analysisParts
      })
      if (aiResponse.success) {
        // åˆå¹¶AIåˆ†æç»“æœ
        Object.entries(aiResponse.data.åˆ†æç»“æœ).forEach(([type, content]) => {
          allResults[type] = content
        })
        selectedTypes.push('è¿åŠ¿é¢„æµ‹')
      }
    }
    
    if (Object.keys(allResults).length > 0) {
      analysisResult.value = {
        åˆ†æç±»å‹: selectedTypes.join('ã€'),
        åˆ†ææ—¶é—´: dayjs().tz('Asia/Shanghai').format(),
        åˆ†æç»“æœ: allResults
      }
      
      // ç”Ÿæˆ markdown æŠ¥å‘Š
      const dt = dayjs(birthDateTime.value).tz('Asia/Shanghai')
      const markdownReport = Object.entries(allResults)
        .map(([type, content]) => `### ${type}\n${content}\n`)
        .join('\n')
      
      // ====== å…³é”®ï¼šä¸¥æ ¼å¯¹é½åç«¯APIæ–‡æ¡£å­—æ®µ ======
      const params = {
        client_analysis_id: `client_${Date.now()}_${Math.random().toString(36).slice(2, 10)}`,
        birth_year: dt.year(),
        birth_month: dt.month() + 1,
        birth_day: dt.date(),
        birth_time: dt.format('HH:mm'),
        gender: (gender.value === 'ç”·' ? 'male' : 'female') as 'male' | 'female',
        analysis_type: selectedTypes.join(','),
        notes: markdownReport,
        display_name: '',
        user_nickname: userStore.user?.username || '',
        analysis_results: allResults,
        summary: {},
        settings: {},
        extra_metadata: {}
      }
      // ======================================
      await baziStore.addAnalysis(params)
      // æ–°å¢ï¼šåˆ†ææˆåŠŸåï¼Œè‹¥ç”¨æˆ·æ— å…«å­—ä¿¡æ¯åˆ™è‡ªåŠ¨ä¿å­˜
      await trySaveUserBaziInfo()
      // æ–°å¢ï¼šåˆ†ææˆåŠŸåè‡ªåŠ¨è·³è½¬åˆ°åˆ†æç»“æœé¡µé¢
      const latest = baziStore.sortedAnalyses[0]
      if (latest) {
        router.push({ path: '/analysis', query: { analysisId: latest.id } })
      }
    } else {
      throw new Error('æ‰€æœ‰åˆ†ææ¥å£éƒ½å¤±è´¥äº†')
    }
  } catch (error: any) {
    alert(error.message || 'åˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯')
  } finally {
    isAnalyzing.value = false
  }
}

// æ–°å¢ï¼šä¿å­˜æŠ¥å‘Šå’Œé‡æ–°åˆ†ææ–¹æ³•
/**
 * ä¿å­˜åˆ†ææŠ¥å‘Šä¸ºå›¾ç‰‡
 */
const handleSaveReport = async () => {
  if (!reportRef.value || !analysisResult.value) return
  // ä½¿ç”¨html2canvaså°†åˆ†ææŠ¥å‘ŠåŒºåŸŸæ¸²æŸ“ä¸ºcanvas
  const canvas = await html2canvas(reportRef.value, {
    backgroundColor: '#fff', // ä¿è¯å›¾ç‰‡èƒŒæ™¯ä¸ºç™½è‰²
    useCORS: true
  })
  // å°†canvasè½¬ä¸ºå›¾ç‰‡å¹¶ä¸‹è½½
  const imgData = canvas.toDataURL('image/png')
  const a = document.createElement('a')
  a.href = imgData
  a.download = `åˆ†ææŠ¥å‘Š_${formatDateTime(analysisResult.value.åˆ†ææ—¶é—´)}.png`
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
}

/**
 * é‡æ–°åˆ†æï¼Œé‡ç½®ç•Œé¢
 */
const handleResetAnalysis = () => {
  analysisResult.value = null
}

// å¯¹è¯æŠ¥å‘ŠæŒ‰é’®é€»è¾‘
const handleChatWithReport = async () => {
  if (!analysisResult.value) return
  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  if (!userStore.user) {
    showLoginModal.value = true
    return
  }
  // æ•´ç†åˆ†ææŠ¥å‘Šä¸ºçº¯æ–‡æœ¬
  const reportText = Object.entries(analysisResult.value.åˆ†æç»“æœ)
    .map(([type, content]) => `ã€${type}ã€‘\n${content}\n`).join('\n')
  const reportName = `å…«å­—åˆ†æ-${formatDateTime(analysisResult.value.åˆ†ææ—¶é—´)}`
  // æ–°å»ºä¸€æ¡å¯¹è¯è®°å½•ï¼Œå¹¶ç­‰å¾…è¿”å›åç«¯ UUID
  const newChatId = await chatStore.createConversation()
  // è·³è½¬åˆ°/chatå¹¶å¸¦ä¸ŠreportContextå’Œnameå‚æ•°ï¼ŒChat.vueä¼šè‡ªåŠ¨æ’å…¥æ°”æ³¡
  router.push({ path: '/chat', query: { reportContext: reportText, name: reportName, conversationId: newChatId } })
}

const chatStore = useChatStore()
const userStore = useUserStore()
const baziStore = useBaziStore()
const route = useRoute()
const router = useRouter()

// ========== æ–°å¢ï¼šè‡ªåŠ¨å¯¼å…¥ç”¨æˆ·å…«å­—ä¿¡æ¯ ========== //
const userHasBaziInfo = computed(() => {
  return !!(
    userStore.user &&
    userStore.user.birth_year &&
    userStore.user.birth_month &&
    userStore.user.birth_day &&
    userStore.user.birth_time &&
    userStore.user.gender
  )
})

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¡«å……
onMounted(async () => {
  // åˆå§‹åŒ–æ•°æ®
  await Promise.all([
    baziStore.initializeStore(),
    baziStore.loadAnalysesFromBackend()
  ])

  // è‡ªåŠ¨å¡«å……ç”¨æˆ·å…«å­—ä¿¡æ¯
  if (userStore.user && userHasBaziInfo.value) {
    // ç»„è£… yyyy-MM-ddTHH:mm ä½œä¸º v-model
    const y = userStore.user.birth_year!.toString().padStart(4, '0')
    const m = userStore.user.birth_month!.toString().padStart(2, '0')
    const d = userStore.user.birth_day!.toString().padStart(2, '0')
    const t = userStore.user.birth_time!.padStart(5, '0')
    birthDateTime.value = `${y}-${m}-${d}T${t}`
    gender.value = userStore.user.gender === 'male' || userStore.user.gender === 'ç”·' ? 'ç”·' : 'å¥³'
  } else if (!userStore.user) {
    // æœªç™»å½•ï¼Œå¡«å……é»˜è®¤å…«å­—ä¿¡æ¯
    birthDateTime.value = '1999-09-09T09:09'
    gender.value = 'ç”·'
  }

  // åˆå§‹åŒ–Intersection Observer
  intersectionObserver.value = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        const type = entry.target.getAttribute('data-type')
        if (type) {
          handleVisibilityChange(type, entry.isIntersecting)
        }
      })
    },
    {
      root: reportRef.value,
      threshold: 0.1
    }
  )
})

// ========== æ–°å¢ï¼šé¦–æ¬¡å¡«å†™è‡ªåŠ¨ä¿å­˜ä¸ºç”¨æˆ·é»˜è®¤å‡ºç”Ÿæ—¥æœŸ ========== //
let hasSavedUserBazi = false // åªä¿å­˜ä¸€æ¬¡
async function trySaveUserBaziInfo() {
  if (!userStore.user || userHasBaziInfo.value || hasSavedUserBazi) return
  // è§£æ birthDateTime
  const dt = birthDateTime.value
  if (!dt || !gender.value) return
  const [date, time] = dt.split('T')
  if (!date || !time) return
  const [year, month, day] = date.split('-').map(Number)
  // ä¿å­˜åˆ°ç”¨æˆ·ä¿¡æ¯
  try {
    await updateUserInfo({
      username: userStore.user.username || '',
      phone: userStore.user.phone || '',
      birth_year: year,
      birth_month: month,
      birth_day: day,
      birth_time: time,
      gender: gender.value === 'ç”·' ? 'male' : 'female'
    })
    await userStore.fetchUser() // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
    hasSavedUserBazi = true
  } catch (e) {
    // å¯åŠ æ—¥å¿—
    console.warn('è‡ªåŠ¨ä¿å­˜ç”¨æˆ·å…«å­—ä¿¡æ¯å¤±è´¥', e)
  }
}

// å†å²åˆ†ææ•°æ®æºï¼Œæ›¿æ¢åŸ chatStore.analysisHistory
const analyses = computed<BaziAnalysis[]>(() => baziStore.sortedAnalyses)

// å½“å‰é€‰ä¸­çš„åˆ†æå†å²ID
const selectedAnalysisId = ref<string | null>(null)

// ç›‘å¬ analyses å’Œ analysisIdï¼Œæ•°æ®å’Œ id ä»»ä¸€å˜åŒ–éƒ½å°è¯•å±•ç¤ºå†å²
watch(
  [analyses, () => route.query.analysisId],
  ([list, id]) => {
    if (id) {
      showAnalysisFromHistory(id as string)
    } else {
      analysisResult.value = null
    }
  },
  { immediate: true }
)

// ç›‘å¬åˆ†æç»“æœå˜åŒ–ï¼Œåˆå§‹åŒ–visibleSections
watch(
  () => analysisResult.value,
  (newResult) => {
    if (newResult) {
      // é‡ç½®å¯è§é¡¹ç›®æ•°é‡
      visibleItems.value = 3
      // å¯¹äºå†å²æ•°æ®ï¼Œç›´æ¥è®¾ç½®ä¸ºå¯è§ï¼›å¯¹äºæ–°åˆ†æï¼Œä½¿ç”¨æ‡’åŠ è½½
      Object.keys(newResult.åˆ†æç»“æœ).forEach(type => {
        // å¦‚æœæ˜¯ä»å†å²è®°å½•åŠ è½½çš„æ•°æ®ï¼Œç›´æ¥è®¾ç½®ä¸ºå¯è§
        if (selectedAnalysisId.value) {
          visibleSections[type] = true
        } else {
          // æ–°åˆ†æä½¿ç”¨æ‡’åŠ è½½
          visibleSections[type] = false
        }
      })
      console.log('Watch triggered - visibleSections updated:', visibleSections)
    }
  }
)

// å±•ç¤ºå†å²åˆ†æ
function showAnalysisFromHistory(id: string) {
  console.log('showAnalysisFromHistory called with id:', id)
  // ç»Ÿä¸€è½¬å­—ç¬¦ä¸²å¯¹æ¯”ï¼Œå…¼å®¹ id/client_analysis_id
  const record = analyses.value.find(r => String(r.id) === String(id) || String((r as any).client_analysis_id) === String(id))
  if (record) {
    console.log('Found analysis record:', record)
    let resultObj = {}
    // ä¼˜å…ˆå…¼å®¹ analysis_results å­—æ®µ
    const analysisResultField = (record as any).analysis_results || (record as any).analysis_result
    // è°ƒè¯•æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥æ•°æ®ç»“æ„
    console.log('å†å²åˆ†æè®°å½•', record)
    console.log('analysis_results:', (record as any).analysis_results)
    console.log('analysis_result:', (record as any).analysis_result)
    console.log('notes:', record.notes)
    if (analysisResultField && Object.keys(analysisResultField).length > 0) {
      resultObj = analysisResultField
    } else if (record.notes) {
      resultObj = parseResultText(record.notes)
    }
    
    // å…ˆæ¸…ç©ºå½“å‰ç»“æœï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“
    analysisResult.value = null
    
    // ä½¿ç”¨nextTickç¡®ä¿DOMæ›´æ–°åå†è®¾ç½®æ–°æ•°æ®
    nextTick(() => {
      analysisResult.value = {
        åˆ†æç±»å‹: record.analysis_type,
        åˆ†ææ—¶é—´: record.created_at,
        åˆ†æç»“æœ: resultObj
      }
      selectedAnalysisId.value = id
      
      // ç«‹å³åˆå§‹åŒ–æ‰€æœ‰sectionsä¸ºå¯è§
      Object.keys(resultObj).forEach(key => {
        visibleSections[key] = true
      })
      
      console.log('Analysis result set:', analysisResult.value)
      console.log('Visible sections initialized:', visibleSections)
    })
  } else {
    console.log('Analysis record not found for id:', id)
    analysisResult.value = null
  }
}

// è§£æçº¯æ–‡æœ¬ä¸ºå¯¹è±¡ï¼ˆç®€å•åˆ†æ®µï¼‰
function parseResultText(text: string) {
  const result: Record<string, string> = {}
  const blocks = text.split(/ã€(.+?)ã€‘/g).filter(Boolean)
  for (let i = 0; i < blocks.length; i += 2) {
    const key = blocks[i]
    const value = blocks[i + 1]?.trim() || ''
    if (key && value) result[key] = value
  }
  return result
}

// ç›´æ¥ç‚¹å‡»å†å²åˆ†æé¡¹æ—¶ï¼Œå¼ºåˆ¶åˆ·æ–°å†…å®¹
function handleSelectAnalysis(id: string) {
  showAnalysisFromHistory(id)
  selectedAnalysisId.value = id
  // å¦‚éœ€åŒæ­¥åˆ° URLï¼Œå¯åŠ ï¼šrouter.replace({ query: { ...route.query, analysisId: id } })
}

const showLoginModal = ref(false)
const handleLoginConfirm = () => {
  showLoginModal.value = false
  router.push('/login')
}
const handleLoginCancel = () => {
  showLoginModal.value = false
}

// æ ¹æ®åˆ†æç±»å‹è¿”å›å›¾æ ‡
const getAnalysisTypeIcon = (type: string) => {
  switch (type) {
    case 'åŸºç¡€åˆ†æ':
      return 'ğŸ“Š'
    case 'ç”¨ç¥åˆ†æ':
      return 'ğŸ¯'
    case 'å…«å­—æ’ç›˜':
      return 'ğŸ”®'
    case 'äº”è¡Œåˆ†æ':
      return 'âš–ï¸'
    case 'æ ¼å±€åˆ¤æ–­':
      return 'ğŸ²'
    case 'è¿åŠ¿é¢„æµ‹':
      return 'ğŸ”®'
    case 'æ€§æ ¼åˆ†æ':
      return 'ğŸ§ '
    case 'äººç”Ÿå»ºè®®':
      return 'ğŸ’¡'
    default:
      return 'ğŸ“'
  }
}

// è·å–æ’åºåçš„åˆ†æç»“æœ
const getSortedAnalysisResults = () => {
  if (!analysisResult.value?.åˆ†æç»“æœ) return []
  
  const entries = Object.entries(analysisResult.value.åˆ†æç»“æœ)
  
  // å®šä¹‰æ’åºä¼˜å…ˆçº§
  const getTypePriority = (type: string): number => {
    // åŸºç¡€åˆ†æç›¸å…³ - ä¼˜å…ˆçº§1
    if (type.includes('åŸºç¡€') || type.includes('å…«å­—') || type.includes('äº”è¡Œ') || type.includes('æ’ç›˜')) {
      return 1
    }
    // ç”¨ç¥åˆ†æç›¸å…³ - ä¼˜å…ˆçº§2
    if (type.includes('ç”¨ç¥') || type.includes('æ ¼å±€') || type.includes('å¿Œç¥')) {
      return 2
    }
    // è¿åŠ¿é¢„æµ‹ç›¸å…³ - ä¼˜å…ˆçº§3
    if (type.includes('è¿åŠ¿') || type.includes('æµå¹´') || type.includes('æµæœˆ') || type.includes('æµæ—¥') || 
        type.includes('æ€§æ ¼') || type.includes('å»ºè®®') || type.includes('é¢„æµ‹')) {
      return 3
    }
    // å…¶ä»–ç±»å‹ - ä¼˜å…ˆçº§4
    return 4
  }
  
  // æŒ‰ä¼˜å…ˆçº§æ’åº
  return entries.sort(([typeA], [typeB]) => {
    const priorityA = getTypePriority(typeA)
    const priorityB = getTypePriority(typeB)
    
    if (priorityA !== priorityB) {
      return priorityA - priorityB
    }
    
    // åŒä¼˜å…ˆçº§å†…æŒ‰å­—æ¯é¡ºåºæ’åº
    return typeA.localeCompare(typeB)
  })
}

// æ ¹æ®åˆ†æç±»å‹è¿”å›æè¿°
const getAnalysisTypeDescription = (type: string) => {
  switch (type) {
    case 'åŸºç¡€åˆ†æ':
      return 'å…«å­—æ’ç›˜ã€äº”è¡Œç»Ÿè®¡ã€å¤§è¿æµå¹´ç­‰åŸºç¡€ä¿¡æ¯'
    case 'ç”¨ç¥åˆ†æ':
      return 'æ ¼å±€åˆ¤æ–­ã€ç”¨ç¥å¿Œç¥åˆ†æã€å–ç”¨åŸåˆ™ç­‰ä¸“ä¸šå†…å®¹'
    case 'å…«å­—æ’ç›˜':
      return 'è¯¦ç»†è§£è¯»æ‚¨çš„å…«å­—å‘½ç›˜ï¼ŒåŒ…æ‹¬äº”è¡Œã€åç¥ã€ç¥ç…ç­‰'
    case 'äº”è¡Œåˆ†æ':
      return 'æ·±å…¥åˆ†ææ‚¨çš„äº”è¡Œå±æ€§ï¼Œæ­ç¤ºæ€§æ ¼ç‰¹ç‚¹å’Œè¿åŠ¿èµ°å‘'
    case 'æ ¼å±€åˆ¤æ–­':
      return 'åˆ¤æ–­æ‚¨çš„å…«å­—æ ¼å±€ï¼Œåˆ†ææ‚¨çš„å‘½è¿èµ°å‘'
    case 'è¿åŠ¿é¢„æµ‹':
      return 'åŸºäºæ‚¨çš„å…«å­—ï¼Œé¢„æµ‹æœªæ¥ä¸€å¹´çš„è¿åŠ¿å˜åŒ–'
    case 'æ€§æ ¼åˆ†æ':
      return 'é€šè¿‡æ‚¨çš„å…«å­—ï¼Œåˆ†ææ‚¨çš„æ€§æ ¼ç‰¹å¾å’Œæ½œåœ¨ä¼˜åŠ¿'
    case 'äººç”Ÿå»ºè®®':
      return 'åŸºäºæ‚¨çš„å…«å­—ï¼Œæä¾›å…·ä½“çš„äººç”Ÿå»ºè®®å’Œè§„åˆ’'
    default:
      return 'è¯¦ç»†åˆ†ææ‚¨çš„å…«å­—ä¿¡æ¯'
  }
}

// æ£€æŸ¥æ˜¯å¦åŒæ—¶å­˜åœ¨åŸºç¡€åˆ†æå’Œç”¨ç¥åˆ†ææ•°æ®
const hasBaseAndYongshenData = () => {
  if (!analysisResult.value?.åˆ†æç»“æœ) return false
  
  const results = analysisResult.value.åˆ†æç»“æœ
  const hasBase = Object.keys(results).some(key => key.includes('åŸºç¡€åˆ†æ'))
  const hasYongshen = Object.keys(results).some(key => key.includes('ç”¨ç¥åˆ†æ'))
  
  return hasBase && hasYongshen
}

// å­˜å‚¨åŸå§‹APIæ•°æ®çš„å¼•ç”¨
const rawBaseData = ref<any>(null)
const rawYongshenData = ref<any>(null)
const rawDayunData = ref<any>(null)

// å°†markdownæ ¼å¼çš„åŸºç¡€åˆ†ææ•°æ®è½¬æ¢ä¸ºç»“æ„åŒ–æ•°æ®
const getStructuredBaseData = (content: string) => {
  // å¦‚æœæœ‰åŸå§‹APIæ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
  if (rawBaseData.value) {
    return rawBaseData.value
  }
  
  // å¦åˆ™ä»markdownå†…å®¹ä¸­è§£æï¼ˆå…¼å®¹å†å²æ•°æ®ï¼‰
  try {
    const lines = content.split('\n')
    const result: any = {
      æ€§åˆ«: 'ç”·',
      å…«å­—ä¿¡æ¯: {},
      äº”è¡Œç»Ÿè®¡: { äº”è¡Œåˆ†å¸ƒ: {}, æœ€å¼ºäº”è¡Œ: '', æœ€å¼±äº”è¡Œ: '' },
      å½“å‰å¤§è¿ä¿¡æ¯: { å¤©å¹²: '', åœ°æ”¯: '', äº”è¡Œ: { å¤©å¹²äº”è¡Œ: '', åœ°æ”¯äº”è¡Œ: '' } },
      æµå¹´æµæœˆæµæ—¥ä¿¡æ¯: {
        æµå¹´: { å¤©å¹²: '', åœ°æ”¯: '', äº”è¡Œ: { å¤©å¹²äº”è¡Œ: '', åœ°æ”¯äº”è¡Œ: '' } },
        æµæœˆ: { å¤©å¹²: '', åœ°æ”¯: '', äº”è¡Œ: { å¤©å¹²äº”è¡Œ: '', åœ°æ”¯äº”è¡Œ: '' } },
        æµæ—¥: { å¤©å¹²: '', åœ°æ”¯: '', äº”è¡Œ: { å¤©å¹²äº”è¡Œ: '', åœ°æ”¯äº”è¡Œ: '' } }
      }
    }
    
    // è§£ææ€§åˆ«
    const genderMatch = content.match(/\*\*æ€§åˆ«ï¼š\*\*\s*([ç”·å¥³])/)
    if (genderMatch) {
      result.æ€§åˆ« = genderMatch[1]
    }
    
    // è§£æå…«å­—ä¿¡æ¯
    const baziMatches = content.matchAll(/\*\*([å¹´æœˆæ—¥æ—¶]æŸ±)ï¼š\*\*\s*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸])([å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])\s*\(([é‡‘æœ¨æ°´ç«åœŸ])([é‡‘æœ¨æ°´ç«åœŸ])\)/g)
    for (const match of baziMatches) {
      const [, pillar, tiangan, dizhi, tianganWuxing, dizhiWuxing] = match
      result.å…«å­—ä¿¡æ¯[pillar] = {
        å¹²æ”¯ç»„åˆ: { å¤©å¹²: tiangan, åœ°æ”¯: dizhi },
        äº”è¡Œå±æ€§: { å¤©å¹²äº”è¡Œ: tianganWuxing, åœ°æ”¯äº”è¡Œ: dizhiWuxing }
      }
    }
    
    // è§£æäº”è¡Œç»Ÿè®¡
    const wuxingMatches = content.matchAll(/- ([é‡‘æœ¨æ°´ç«åœŸ])ï¼š(\d+)/g)
    for (const match of wuxingMatches) {
      const [, element, count] = match
      result.äº”è¡Œç»Ÿè®¡.äº”è¡Œåˆ†å¸ƒ[element] = parseInt(count)
    }
    
    const strongestMatch = content.match(/\*\*æœ€å¼ºäº”è¡Œï¼š\*\*\s*([é‡‘æœ¨æ°´ç«åœŸ])/)
    if (strongestMatch) {
      result.äº”è¡Œç»Ÿè®¡.æœ€å¼ºäº”è¡Œ = strongestMatch[1]
    }
    
    const weakestMatch = content.match(/\*\*æœ€å¼±äº”è¡Œï¼š\*\*\s*([é‡‘æœ¨æ°´ç«åœŸ])/)
    if (weakestMatch) {
      result.äº”è¡Œç»Ÿè®¡.æœ€å¼±äº”è¡Œ = weakestMatch[1]
    }
    
    // è§£æå¤§è¿ä¿¡æ¯
    const dayunMatch = content.match(/\*\*å¤§è¿ï¼š\*\*\s*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸])([å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])\s*\(([é‡‘æœ¨æ°´ç«åœŸ])([é‡‘æœ¨æ°´ç«åœŸ])\)/)
    if (dayunMatch) {
      const [, tiangan, dizhi, tianganWuxing, dizhiWuxing] = dayunMatch
      result.å½“å‰å¤§è¿ä¿¡æ¯ = {
        å¤©å¹²: tiangan,
        åœ°æ”¯: dizhi,
        äº”è¡Œ: { å¤©å¹²äº”è¡Œ: tianganWuxing, åœ°æ”¯äº”è¡Œ: dizhiWuxing }
      }
    }
    
    // è§£ææµå¹´æµæœˆæµæ—¥
    const liuNianMatch = content.match(/\*\*æµå¹´ï¼š\*\*\s*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸])([å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])\s*\(([é‡‘æœ¨æ°´ç«åœŸ])([é‡‘æœ¨æ°´ç«åœŸ])\)/)
    if (liuNianMatch) {
      const [, tiangan, dizhi, tianganWuxing, dizhiWuxing] = liuNianMatch
      result.æµå¹´æµæœˆæµæ—¥ä¿¡æ¯.æµå¹´ = {
        å¤©å¹²: tiangan,
        åœ°æ”¯: dizhi,
        äº”è¡Œ: { å¤©å¹²äº”è¡Œ: tianganWuxing, åœ°æ”¯äº”è¡Œ: dizhiWuxing }
      }
    }
    
    const liuYueMatch = content.match(/\*\*æµæœˆï¼š\*\*\s*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸])([å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])\s*\(([é‡‘æœ¨æ°´ç«åœŸ])([é‡‘æœ¨æ°´ç«åœŸ])\)/)
    if (liuYueMatch) {
      const [, tiangan, dizhi, tianganWuxing, dizhiWuxing] = liuYueMatch
      result.æµå¹´æµæœˆæµæ—¥ä¿¡æ¯.æµæœˆ = {
        å¤©å¹²: tiangan,
        åœ°æ”¯: dizhi,
        äº”è¡Œ: { å¤©å¹²äº”è¡Œ: tianganWuxing, åœ°æ”¯äº”è¡Œ: dizhiWuxing }
      }
    }
    
    const liuRiMatch = content.match(/\*\*æµæ—¥ï¼š\*\*\s*([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸])([å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥])\s*\(([é‡‘æœ¨æ°´ç«åœŸ])([é‡‘æœ¨æ°´ç«åœŸ])\)/)
    if (liuRiMatch) {
      const [, tiangan, dizhi, tianganWuxing, dizhiWuxing] = liuRiMatch
      result.æµå¹´æµæœˆæµæ—¥ä¿¡æ¯.æµæ—¥ = {
        å¤©å¹²: tiangan,
        åœ°æ”¯: dizhi,
        äº”è¡Œ: { å¤©å¹²äº”è¡Œ: tianganWuxing, åœ°æ”¯äº”è¡Œ: dizhiWuxing }
      }
    }
    
    return result
  } catch (error) {
    console.error('è§£æåŸºç¡€åˆ†ææ•°æ®å¤±è´¥:', error)
    return null
  }
}

// å°†markdownæ ¼å¼çš„ç”¨ç¥åˆ†ææ•°æ®è½¬æ¢ä¸ºç»“æ„åŒ–æ•°æ®
const getStructuredYongshenData = (content: string) => {
  // å¦‚æœæœ‰åŸå§‹APIæ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
  if (rawYongshenData.value) {
    return rawYongshenData.value
  }
  
  // å¦åˆ™ä»markdownå†…å®¹ä¸­è§£æï¼ˆå…¼å®¹å†å²æ•°æ®ï¼‰
  try {
    const result: any = {
      æ ¼å±€: '',
      ç”¨ç¥: [],
      å¿Œç¥: [],
      å–ç”¨: '',
      åˆ†æ: ''
    }
    
    // è§£ææ ¼å±€
    const geJuMatch = content.match(/\*\*æ ¼å±€ï¼š\*\*\s*([^\n]+)/)
    if (geJuMatch) {
      result.æ ¼å±€ = geJuMatch[1].trim()
    }
    
    // è§£æç”¨ç¥
    const yongshenSection = content.match(/### ç”¨ç¥\n\n([\s\S]*?)\n\n### å¿Œç¥/)
    if (yongshenSection) {
      const yongshenLines = yongshenSection[1].split('\n')
      result.ç”¨ç¥ = yongshenLines
        .filter(line => line.trim().startsWith('- '))
        .map(line => line.replace(/^- /, '').trim())
    }
    
    // è§£æå¿Œç¥
    const jishenSection = content.match(/### å¿Œç¥\n\n([\s\S]*?)\n\n\*\*å–ç”¨åŸåˆ™ï¼š\*\*/)
    if (jishenSection) {
      const jishenLines = jishenSection[1].split('\n')
      result.å¿Œç¥ = jishenLines
        .filter(line => line.trim().startsWith('- '))
        .map(line => line.replace(/^- /, '').trim())
    }
    
    // è§£æå–ç”¨åŸåˆ™
    const quyongMatch = content.match(/\*\*å–ç”¨åŸåˆ™ï¼š\*\*\s*([^\n]+)/)
    if (quyongMatch) {
      result.å–ç”¨ = quyongMatch[1].trim()
    }
    
    // è§£æåˆ†æç»“è®º
    const analysisSection = content.match(/### åˆ†æç»“è®º\n\n([\s\S]*?)$/)
    if (analysisSection) {
      result.åˆ†æ = analysisSection[1].trim()
    }
    
    return result
  } catch (error) {
    console.error('è§£æç”¨ç¥åˆ†ææ•°æ®å¤±è´¥:', error)
    return null
  }
}
</script>

<style>
/* åŸºç¡€æ–‡æœ¬æ ·å¼ */
.prose {
  color: #1f2937; /* text-gray-800 */
}

.dark .prose {
  color: #e5e7eb; /* dark:text-gray-200 */
}

/* æ ‡é¢˜æ ·å¼ */
.prose h1,
.prose h2,
.prose h3,
.prose h4,
.prose h5,
.prose h6 {
  color: #1f2937; /* text-gray-800 */
}

.dark .prose h1,
.dark .prose h2,
.dark .prose h3,
.dark .prose h4,
.dark .prose h5,
.dark .prose h6 {
  color: #e5e7eb; /* dark:text-gray-200 */
}

.prose h3 {
  font-size: 1.125rem; /* text-lg */
  font-weight: 500; /* font-medium */
  margin-top: 1rem; /* mt-4 */
  margin-bottom: 0.5rem; /* mb-2 */
}

/* æ®µè½æ ·å¼ */
.prose p {
  margin-top: 0.5rem; /* my-2 */
  margin-bottom: 0.5rem; /* my-2 */
  color: #1f2937; /* text-gray-800 */
}

.dark .prose p {
  color: #e5e7eb; /* dark:text-gray-200 */
}

/* åˆ—è¡¨æ ·å¼ */
.prose ul {
  list-style-type: disc; /* list-disc */
  list-style-position: inside; /* list-inside */
  margin-top: 0.5rem; /* my-2 */
  margin-bottom: 0.5rem; /* my-2 */
  color: #1f2937; /* text-gray-800 */
}

.dark .prose ul {
  color: #e5e7eb; /* dark:text-gray-200 */
}

.prose li {
  margin-top: 0.25rem; /* my-1 */
  margin-bottom: 0.25rem; /* my-1 */
  color: #1f2937; /* text-gray-800 */
}

.dark .prose li {
  color: #e5e7eb; /* dark:text-gray-200 */
}

/* å¼ºè°ƒæ ·å¼ */
.prose strong {
  color: #1f2937; /* text-gray-800 */
  font-weight: 600; /* font-semibold */
}

.dark .prose strong {
  color: #e5e7eb; /* dark:text-gray-200 */
}

/* æµå¹´æµæœˆæµæ—¥ä¿¡æ¯ç‰¹æ®Šæ ·å¼ */
.prose .time-info-label {
  color: #059669; /* text-emerald-600 */
  font-weight: 500; /* font-medium */
  font-size: 0.9rem; /* text-sm */
}

.dark .prose .time-info-label {
  color: #10b981; /* dark:text-emerald-500 */
}

.prose .time-info-content {
  color: #1f2937; /* text-gray-800 */
  font-weight: 400; /* font-normal */
  font-size: 0.9rem; /* text-sm */
}

.dark .prose .time-info-content {
  color: #d1d5db; /* dark:text-gray-300 */
}

.prose em {
  color: #1f2937; /* text-gray-800 */
  font-style: italic; /* italic */
}

.dark .prose em {
  color: #e5e7eb; /* dark:text-gray-200 */
}

/* é“¾æ¥æ ·å¼ */
.prose a {
  color: #2563eb; /* text-blue-600 */
}

.dark .prose a {
  color: #60a5fa; /* dark:text-blue-400 */
}

.prose a:hover {
  color: #1d4ed8; /* hover:text-blue-800 */
}

.dark .prose a:hover {
  color: #93c5fd; /* dark:hover:text-blue-300 */
}

/* å¼•ç”¨æ ·å¼ */
.prose blockquote {
  border-left-width: 4px; /* border-l-4 */
  border-left-color: #d1d5db; /* border-gray-300 */
  padding-left: 1rem; /* pl-4 */
  color: #374151; /* text-gray-700 */
}

.dark .prose blockquote {
  border-left-color: #4b5563; /* dark:border-gray-600 */
  color: #d1d5db; /* dark:text-gray-300 */
}

/* ä»£ç æ ·å¼ */
.prose code {
  background-color: #f3f4f6; /* bg-gray-100 */
  color: #1f2937; /* text-gray-800 */
  padding: 0.125rem 0.25rem; /* px-1 py-0.5 */
  border-radius: 0.25rem; /* rounded */
  font-size: 0.875rem; /* text-sm */
}

.dark .prose code {
  background-color: #374151; /* dark:bg-gray-700 */
  color: #e5e7eb; /* dark:text-gray-200 */
}

.prose pre {
  background-color: #f3f4f6; /* bg-gray-100 */
  color: #1f2937; /* text-gray-800 */
  padding: 1rem; /* p-4 */
  border-radius: 0.5rem; /* rounded-lg */
  overflow-x: auto; /* overflow-x-auto */
}

.dark .prose pre {
  background-color: #374151; /* dark:bg-gray-700 */
  color: #e5e7eb; /* dark:text-gray-200 */
}

.prose pre code {
  background-color: transparent; /* bg-transparent */
  color: inherit; /* text-inherit */
  padding: 0; /* p-0 */
}
</style>